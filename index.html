<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Peptide/Supplement Logger</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <meta name="theme-color" content="#3b82f6">
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f6f7fb; color:#222; }
    header { background: #3b82f6; color:#fff; padding: 1em; text-align:center; }
    .container { max-width:500px; margin:2em auto; padding:1em; background:#fff; box-shadow:0 2px 16px #0002; border-radius:1em; }
    #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; margin-bottom:1em; background:#e5e7eb; }
    .calendar-day { background:#fff; min-height:32px; text-align:center; padding:0.7em 0 0.2em 0; cursor:pointer; position:relative; border-radius:0.5em; }
    .calendar-day.selected { background:#e0e7ff; }
    .dots { position:absolute; left:50%; bottom:3px; transform:translateX(-50%); display:flex; gap:2px;}
    .dot { display:inline-block; width:6px; height:6px; background:#3b82f6; border-radius:50%; }
    .plus { font-size:0.7em; color:#555; margin-left:2px; }
    .entry-row { display:flex; align-items:center; gap:0.7em; margin-bottom:0.5em; }
    .entry-name { flex:2; }
    .entry-time { flex:1; min-width:130px; }
    .entry-actions button { margin-left: 0.5em; }
    #buttonsPanel { display:flex; flex-wrap:wrap; gap:0.5em; margin-bottom:1em; }
    #buttonsPanel button { padding:0.8em 1.2em; border:none; background:#e0e7ff; color:#1e293b; border-radius:0.6em; font-size:1em; cursor:pointer; transition:background 0.2s; }
    #buttonsPanel button:hover { background:#3b82f6; color:#fff; }
    #lastList { margin-bottom:1em; }
    .last-item { margin-bottom:0.3em; }
    #toast { position:fixed; left:50%; bottom:32px; transform:translateX(-50%); background:#3b82f6; color:#fff; padding:0.7em 1.5em; border-radius:2em; opacity:0; pointer-events:none; transition:opacity 0.4s;}
    #toast.visible { opacity:1; }
    #status { position:fixed; top:0; left:0; right:0; text-align:center; padding:0.7em 0; font-weight:bold; opacity:0; pointer-events:none; transition:opacity 0.4s;}
    #status.visible { opacity:1; }
    @media (max-width:650px) { .container { margin:0; border-radius:0; box-shadow:none; } }
  </style>
</head>
<body>
  <header>
    <h1>Peptide / Supplement Logger</h1>
  </header>
  <div class="container">
    <section>
      <div id="buttonsPanel"></div>
      <div id="lastList"></div>
    </section>
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <button id="prevMonthBtn" aria-label="Previous Month">&lt;</button>
        <span id="monthLabel" style="font-weight:bold;"></span>
        <button id="nextMonthBtn" aria-label="Next Month">&gt;</button>
      </div>
      <div id="calendarGrid"></div>
    </section>
    <section id="entriesPanel" style="display:none;">
      <div style="font-weight:bold;margin-bottom:8px;">Entries for <span id="selectedDateLabel"></span></div>
      <div id="entriesList"></div>
    </section>
  </div>
  <div id="toast"></div>
  <div id="status"></div>
  <script>
    // ====== CONFIG (EDIT ME) ======
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_gP7W6wMkcH3ou-l7a_Xdps57JkMlaQP3SrMimQ-vYtWDGnGxCiz1AwLKWGxorcti/exec'; // <-- EDIT ME
    const API_TOKEN = ''; // optional, set if Apps Script enforces a token
    // ====== END CONFIG ======

    // Supplement List (short and full names)
    const SUPPLEMENTS = [
      { code: "Tesa", name: "Tesamorelin" },
      { code: "NAD", name: "NAD+ Buffered" },
      { code: "BPC", name: "BPC-157" },
      { code: "Semax", name: "Semax" },
      { code: "Tirz", name: "Tirzepatide" },
      { code: "TB4", name: "TB-4" },
      { code: "Mots-C", name: "MOTS-C" },
      { code: "MLT", name: "Melanotan I" },
      { code: "CJC/IPA", name: "CJC-no DAC / Ipamorelin (5mg/5mg blend)" },
      { code: "TRT", name: "Testosterone cypionate (IM)" },
      { code: "SS-31", name: "SS-31" },
      { code: "Epita", name: "Epitalon" }
    ];

    // Guard: prevent silent failure if URL not set
    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR_APPS_SCRIPT')) {
      alert('Configure APPS_SCRIPT_URL in index.html before using the app.');
    }

    // Time helpers (use device tz; include offset in ISO)
    function localISO(dt = new Date()) {
      const tzo  = -dt.getTimezoneOffset();         // minutes east of UTC
      const sign = tzo >= 0 ? '+' : '-';
      const pad2 = n => String(Math.trunc(Math.abs(n))).padStart(2, '0');

      const y  = dt.getFullYear();
      const m  = pad2(dt.getMonth() + 1);
      const d  = pad2(dt.getDate());
      const hh = pad2(dt.getHours());
      const mm = pad2(dt.getMinutes());
      const ss = pad2(dt.getSeconds());

      const offH = pad2(tzo / 60);
      const offM = pad2(tzo % 60);

      return `${y}-${m}-${d}T${hh}:${mm}:${ss}${sign}${offH}:${offM}`;
    }
    function fmtDate(dt){ return dt.toLocaleDateString('en-CA'); } // YYYY-MM-DD (device tz)
    function fmtTime(dt){ return dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function fmtMonthLabel(dt){ return dt.toLocaleString([], {month:'long',year:'numeric'}); }
    function toDatetimeLocal(iso){
      const d = new Date(iso);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      const h=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${day}T${h}:${min}`;
    }
    function fmtLast(iso){
      if(!iso) return 'â€”';
      const d=new Date(iso); const today=fmtDate(new Date()); const ds=fmtDate(d);
      return ds===today ? fmtTime(d) : `${ds} ${fmtTime(d)}`;
    }

    // ----- App State -----
    let items = SUPPLEMENTS.map(s => s.code); // supplement/peptide codes
    let lastTaken = []; // [{item: code, iso}]
    let calendarData = {}; // {'YYYY-MM-DD': [entry,...]}
    let selectedDate = null; // 'YYYY-MM-DD'
    let currentMonth = new Date();

    // ----- UI Utils -----
    function toast(msg){
      const el=document.getElementById('toast'); el.textContent=msg;
      el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'), 2200);
    }
    function statusMsg(msg, isError=false){
      const el=document.getElementById('status'); el.textContent=msg;
      el.style.background=isError?'#e11d48':'#3b82f6';
      el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'), 3000);
    }
    function confirmDialog(msg){ return window.confirm(msg); }

    // ----- API -----
    async function apiGET(params){
      let url = `${APPS_SCRIPT_URL}?${params}`;
      if (API_TOKEN) url += `&token=${encodeURIComponent(API_TOKEN)}`;
      url += `${url.includes('?') ? '&' : '?'}_=${Date.now()}`;
      const r = await fetch(url, { cache: 'no-store' });
      return r.json();
    }
    async function apiPOST(obj){
      const fd = new FormData();
      Object.entries(obj).forEach(([k,v]) => fd.append(k,v));
      if (API_TOKEN) fd.append('token', API_TOKEN);
      const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body: fd });
      return r.json();
    }

    // ----- Calendar -----
    function renderCalendar(){
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML='';
      const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
      const first = new Date(y,m,1), days = new Date(y,m+1,0).getDate();
      const startDow = first.getDay(); // 0 Sun
      const todayStr = fmtDate(new Date());

      // pad to the first weekday
      for(let i=0;i<startDow;i++) grid.appendChild(document.createElement('div'));

      for(let day=1; day<=days; day++){
        const cell = document.createElement('div'); cell.className='calendar-day';
        const d = new Date(y,m,day); const ds = fmtDate(d);
        if (ds===todayStr) cell.style.outline = '2px solid #3b82f6';
        if (selectedDate===ds) cell.classList.add('selected');
        cell.setAttribute('aria-label', `Day ${day}`);
        cell.textContent = day;

        const logs = calendarData[ds] || [];
        if (logs.length){
          const dots = document.createElement('div'); dots.className='dots';
          const dotCt = Math.min(logs.length, 5);
          for(let i=0;i<dotCt;i++){
            const dot=document.createElement('span');
            dot.className='dot';
            // Use short code as tooltip, full name as accessible label
            const entry = logs[i];
            const supp = SUPPLEMENTS.find(s => s.code === entry.item);
            dot.title = supp ? supp.name : entry.item;
            dot.setAttribute('aria-label', supp ? supp.name : entry.item);
            dots.appendChild(dot);
          }
          if (logs.length>5){
            const more=document.createElement('span');
            more.className='plus';
            more.textContent=`+${logs.length-5}`;
            dots.appendChild(more);
          }
          cell.appendChild(dots);
        }
        cell.onclick = () => { selectedDate = ds; renderCalendar(); renderEntriesPanel(); };
        grid.appendChild(cell);
      }
      document.getElementById('monthLabel').textContent = fmtMonthLabel(currentMonth);
    }
    function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); selectedDate=null; refreshAll(); }
    function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); selectedDate=null; refreshAll(); }

    // ----- Entries Panel -----
    function renderEntriesPanel(){
      const panel = document.getElementById('entriesPanel');
      const label = document.getElementById('selectedDateLabel');
      const list = document.getElementById('entriesList');
      if (!selectedDate) { panel.style.display='none'; return; }
      panel.style.display=''; label.textContent = selectedDate; list.innerHTML='';

      const rows = (calendarData[selectedDate] || []).sort((a,b)=> new Date(a.iso)-new Date(b.iso));
      if (!rows.length){ list.textContent='No entries for this day.'; return; }

      rows.forEach(entry=>{
        const row=document.createElement('div'); row.className='entry-row';
        const supp = SUPPLEMENTS.find(s => s.code === entry.item);
        // Show both short and full name
        const name=document.createElement('span');
        name.className='entry-name';
        name.innerHTML = supp
          ? `<strong>${supp.code}</strong> <span style="font-size:0.95em;color:#444;">${supp.name}</span>`
          : entry.item;

        const time=document.createElement('input'); time.type='datetime-local'; time.className='entry-time'; time.value=toDatetimeLocal(entry.iso);
        const actions=document.createElement('span'); actions.className='entry-actions';
        const save=document.createElement('button'); save.textContent='Save';
        const del=document.createElement('button'); del.textContent='Delete';

        save.onclick = async ()=>{
          if(!confirmDialog('Update this log entry time?')) return;
          save.disabled=true;
          try{
            const iso = localISO(new Date(time.value));
            const resp = await apiPOST({action:'update', id:entry.id, ts:iso});
            if(resp.ok){ toast(`Saved ${supp ? supp.code : entry.item}`); await refreshAll(); } else throw new Error();
          }catch{ statusMsg('Failed to update entry', true); }
          finally{ save.disabled=false; }
        };
        del.onclick = async ()=>{
          if(!confirmDialog('Delete this log entry?')) return;
          del.disabled=true;
          try{
            const resp = await apiPOST({action:'delete', id:entry.id});
            if(resp.ok){ toast(`Deleted ${supp ? supp.code : entry.item}`); await refreshAll(); } else throw new Error();
          }catch{ statusMsg('Failed to delete', true); }
          finally{ del.disabled=false; }
        };

        actions.append(save, del);
        row.append(name, time, actions);
        list.appendChild(row);
      });
    }

    // ----- Last Taken Panel -----
    function renderLastPanel(){
      const list = document.getElementById('lastList'); list.innerHTML='';
      lastTaken.forEach(({item, iso})=>{
        const supp = SUPPLEMENTS.find(s => s.code === item);
        const div=document.createElement('div'); div.className='last-item';
        div.innerHTML = supp
          ? `<strong>${supp.code}</strong> <span style="font-size:0.95em;color:#444;">${supp.name}</span>: ${fmtLast(iso)}`
          : `${item}: ${fmtLast(iso)}`;
        list.appendChild(div);
      });
    }

    // ----- Buttons Panel -----
    function renderButtonsPanel(){
      const panel = document.getElementById('buttonsPanel'); panel.innerHTML='';
      SUPPLEMENTS.forEach(supp=>{
        const btn=document.createElement('button');
        btn.textContent = supp.code;
        btn.title = supp.name;
        btn.setAttribute('aria-label', supp.name);
        btn.onclick = async ()=>{
          if (!confirmDialog(`Log "${supp.name}" right now?`)) return;
          btn.disabled=true;
          try{
            const now=new Date(); const iso = localISO(now);
            const resp = await apiPOST({action:'log', item: supp.code, ts: iso});
            if (resp.ok){ toast(`Logged ${supp.code} at ${fmtTime(now)}`); await refreshAll(); } else throw new Error();
          }catch{ statusMsg('Failed to log', true); }
          finally{ btn.disabled=false; }
        };
        panel.appendChild(btn);
      });
    }

    // ----- Refresh All -----
    async function refreshAll(){
      const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
      const start = new Date(y,m,1), end = new Date(y,m+1,0,23,59,59);
      try{
        // Items and lastTaken could still be fetched if needed, but we use SUPPLEMENTS for UI
        const lastResp = await apiGET('action=last'); if(lastResp.ok) lastTaken = lastResp.data || [];
        renderLastPanel();

        const listResp = await apiGET(`action=list&start=${encodeURIComponent(start.toISOString())}&end=${encodeURIComponent(end.toISOString())}`);
        calendarData = {};
        if (listResp.ok){
          (listResp.data||[]).forEach(entry=>{
            const ds = fmtDate(new Date(entry.iso));
            (calendarData[ds] ||= []).push(entry);
          });
        }
        renderCalendar(); renderEntriesPanel();
        renderButtonsPanel();
      }catch{ statusMsg('Network or API error', true); }
    }

    // ----- Init -----
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('prevMonthBtn').onclick = prevMonth;
      document.getElementById('nextMonthBtn').onclick = nextMonth;
      refreshAll();
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }
    });
  </script>
</body>
</html>
