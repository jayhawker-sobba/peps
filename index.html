<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Peptide / Supplement Logger</title>
  <meta name="theme-color" content="#3b82f6" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f6f7fb; color:#222; }
    header { background:#3b82f6; color:#fff; padding:1rem; text-align:center; font-weight:700; }
    .container { max-width:600px; margin:2rem auto; padding:1rem; background:#fff; border-radius:12px; box-shadow:0 2px 16px #0001; }
    h3 { margin:0 0 .5rem 0; }
    #buttonsPanel { display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0 1rem; }
    #buttonsPanel button { padding:.7rem 1rem; border:none; border-radius:.6rem; background:#e0e7ff; color:#1e293b; cursor:pointer; }
    #buttonsPanel button:hover { background:#3b82f6; color:#fff; }
    #lastList .last-item { margin:.25rem 0; }
    .cal-head { display:flex; align-items:center; justify-content:space-between; margin:.75rem 0; }
    .cal-nav { width:40px; height:40px; border:none; border-radius:10px; background:#e7edf8; cursor:pointer; }
    #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; background:#e5e7eb; border-radius:8px; padding:2px; }
    .weekday { text-align:center; font-size:.9rem; color:#475569; margin:.3rem 0 .4rem; }
    .calendar-day { background:#fff; min-height:40px; text-align:center; padding:.65rem 0 .2rem; cursor:pointer; position:relative; border-radius:6px; }
    .calendar-day.selected { background:#e0e7ff; }
    .dots { position:absolute; left:50%; bottom:4px; transform:translateX(-50%); display:flex; gap:2px; }
    .dot { width:6px; height:6px; border-radius:50%; background:#3b82f6; display:inline-block; }
    .plus { font-size:.7rem; color:#475569; margin-left:2px; }
    #entriesPanel { margin-top:1rem; }
    .entry-row { display:flex; align-items:center; gap:.5rem; margin:.4rem 0; }
    .entry-name { min-width:140px; font-weight:600; }
    .entry-time { min-width:170px; }
    .entry-actions button { padding:.4rem .7rem; }
    #toast { position:fixed; left:50%; bottom:28px; transform:translateX(-50%); background:#3b82f6; color:#fff; padding:.6rem 1.2rem; border-radius:999px; opacity:0; pointer-events:none; transition:opacity .25s; }
    #toast.visible { opacity:1; }
    #status { position:fixed; top:0; left:0; right:0; text-align:center; padding:.55rem; font-weight:700; opacity:0; pointer-events:none; transition:opacity .25s; }
    #status.visible { opacity:1; }
    @media (max-width:640px) { .container { margin:0; border-radius:0; box-shadow:none; } }
  </style>
</head>
<body>
  <header>Peptide / Supplement Logger</header>

  <div class="container">
    <section>
      <h3>Log Now</h3>
      <div id="buttonsPanel"></div>
    </section>

    <section>
      <h3>Last Taken</h3>
      <div id="lastList"></div>
    </section>

    <section>
      <div class="cal-head">
        <button id="prevMonthBtn" class="cal-nav" aria-label="Previous Month">◀</button>
        <div>
          <div id="monthLabel" style="text-align:center;font-weight:700;"></div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:.2rem;">
            <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
            <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
          </div>
        </div>
        <button id="nextMonthBtn" class="cal-nav" aria-label="Next Month">▶</button>
      </div>
      <div id="calendarGrid"></div>
    </section>

    <section id="entriesPanel" style="display:none;">
      <div style="font-weight:700;margin:.6rem 0;">Entries for <span id="selectedDateLabel"></span></div>
      <div id="entriesList"></div>
    </section>
  </div>

  <div id="toast"></div>
  <div id="status"></div>

  <script>
    // ======= CONFIG =======
    const APPS_SCRIPT_URL =
      'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgVjzEQgxWueYulgjNLMyeD7Y2ylm3vfHzWDZ60H-UCyl1GUQx7Fp7ZhCXV3VYGVPaXR3acc90kLGgnpnT0mPV8YcNH7G48FgNbuI9XNQmNbh1oveaucwlhIyOVtkmI81_6Ria8qk7jvQ4GQfrqd8FVApOmIIN7R8431bvCWLOXIDaFKgV31hubGpybKXKypl11tXni_2IdN9OdOVFiCyDPdgxdK2Bx90fPbFRPAtVyhr3H145HQrGdoorFWQ&lib=MtK1z2NrdGgBhNnG66tKP8Q0rWYMbTwle';
    const API_TOKEN = ''; // keep blank unless you enabled TOKEN in Apps Script
    // ======================

    // ---- Time helpers ----
    function localISO(dt = new Date()) {
      const tzo = -dt.getTimezoneOffset(), sign = tzo >= 0 ? '+' : '-';
      const pad2 = n => String(Math.trunc(Math.abs(n))).padStart(2,'0');
      const y = dt.getFullYear(), m = pad2(dt.getMonth()+1), d = pad2(dt.getDate());
      const hh = pad2(dt.getHours()), mm = pad2(dt.getMinutes()), ss = pad2(dt.getSeconds());
      const offH = pad2(tzo/60), offM = pad2(tzo%60);
      return `${y}-${m}-${d}T${hh}:${mm}:${ss}${sign}${offH}:${offM}`;
    }
    const fmtDate = dt => dt.toLocaleDateString('en-CA'); // YYYY-MM-DD
    const fmtTime = dt => dt.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    const fmtMonthLabel = dt => dt.toLocaleString([], { month:'long', year:'numeric' });
    const toDatetimeLocal = iso => {
      const d = new Date(iso);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0'), h=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${day}T${h}:${min}`;
    };
    function fmtLast(iso){
      if(!iso) return '—';
      const d=new Date(iso), today=fmtDate(new Date()), ds=fmtDate(d);
      return ds===today ? fmtTime(d) : `${ds} ${fmtTime(d)}`;
    }

    // ---- State ----
    let lastTaken = [];
    let calendarData = {};
    let selectedDate = null;
    let currentMonth = new Date();

    // ---- UI helpers ----
    function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'), 2000); }
    function statusMsg(msg,isError=false){ const el=document.getElementById('status'); el.textContent=msg; el.style.background=isError?'#e11d48':'#3b82f6'; el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'),2500); }
    const confirmDialog = msg => window.confirm(msg);

    // ---- API ----
    async function apiGET(params){
      let url = `${APPS_SCRIPT_URL}?${params}`;
      if (API_TOKEN) url += `&token=${encodeURIComponent(API_TOKEN)}`;
      const r = await fetch(url, { cache:'no-store' });
      return r.json();
    }
    async function apiPOST(obj){
      const fd = new FormData();
      Object.entries(obj).forEach(([k,v]) => fd.append(k,v));
      if (API_TOKEN) fd.append('token', API_TOKEN);
      const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:fd });
      return r.json();
    }

    // ---- Calendar ----
    function renderCalendar(){
      const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
      const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
      const first=new Date(y,m,1), days=new Date(y,m+1,0).getDate(), startDow=first.getDay();
      const todayStr = fmtDate(new Date());
      for(let i=0;i<startDow;i++) grid.appendChild(document.createElement('div'));
      for(let day=1; day<=days; day++){
        const cell=document.createElement('div'); cell.className='calendar-day';
        const d=new Date(y,m,day); const ds=fmtDate(d);
        if(ds===todayStr) cell.style.outline='2px solid #3b82f6';
        if(selectedDate===ds) cell.classList.add('selected');
        cell.textContent=day;
        const logs=calendarData[ds]||[];
        if(logs.length){
          const dots=document.createElement('div'); dots.className='dots';
          const dotCt=Math.min(logs.length,5);
          for(let i=0;i<dotCt;i++){ const dot=document.createElement('span'); dot.className='dot'; dots.appendChild(dot); }
          if(logs.length>5){ const more=document.createElement('span'); more.className='plus'; more.textContent=`+${logs.length-5}`; dots.appendChild(more); }
          cell.appendChild(dots);
        }
        cell.onclick=()=>{ selectedDate=ds; renderCalendar(); renderEntriesPanel(); };
        grid.appendChild(cell);
      }
      document.getElementById('monthLabel').textContent = fmtMonthLabel(currentMonth);
    }
    const prevMonth = () => { currentMonth.setMonth(currentMonth.getMonth()-1); selectedDate=null; refreshAll(); };
    const nextMonth = () => { currentMonth.setMonth(currentMonth.getMonth()+1); selectedDate=null; refreshAll(); };

    // ---- Entries panel ----
    function renderEntriesPanel(){
      const panel=document.getElementById('entriesPanel');
      const label=document.getElementById('selectedDateLabel');
      const list=document.getElementById('entriesList');
      if(!selectedDate){ panel.style.display='none'; return; }
      panel.style.display=''; label.textContent=selectedDate; list.innerHTML='';
      const rows=(calendarData[selectedDate]||[]).sort((a,b)=> new Date(a.iso)-new Date(b.iso));
      if(!rows.length){ list.textContent='No entries for this day.'; return; }
      rows.forEach(entry=>{
        const row=document.createElement('div'); row.className='entry-row';
        const name=document.createElement('span'); name.className='entry-name'; name.textContent=entry.item;
        const time=document.createElement('input'); time.type='datetime-local'; time.className='entry-time'; time.value=toDatetimeLocal(entry.iso);
        const actions=document.createElement('span'); actions.className='entry-actions';
        const save=document.createElement('button'); save.textContent='Save';
        const del=document.createElement('button'); del.textContent='Delete';
        save.onclick=async()=>{ if(!confirmDialog('Update this log entry time?')) return;
          const iso=localISO(new Date(time.value)); const resp=await apiPOST({action:'update', id:entry.id, ts:iso});
          if(resp.ok){ toast(`Saved ${entry.item}`); await refreshAll(); } else statusMsg('Failed to update entry',true);
        };
        del.onclick=async()=>{ if(!confirmDialog('Delete this log entry?')) return;
          const resp=await apiPOST({action:'delete', id:entry.id});
          if(resp.ok){ toast(`Deleted ${entry.item}`); await refreshAll(); } else statusMsg('Failed to delete',true);
        };
        actions.append(save, del); row.append(name, time, actions); list.appendChild(row);
      });
    }

    // ---- Last Taken ----
    function renderLastPanel(){
      const list=document.getElementById('lastList'); list.innerHTML='';
      lastTaken.forEach(({item,iso})=>{
        const div=document.createElement('div'); div.className='last-item';
        div.textContent = `${item}: ${fmtLast(iso)}`;
        list.appendChild(div);
      });
    }

    // ---- Buttons ----
    function renderButtonsPanel(items){
      const panel=document.getElementById('buttonsPanel'); panel.innerHTML='';
      items.forEach(item=>{
        const btn=document.createElement('button'); btn.textContent=item;
        btn.onclick=async()=>{
          if(!confirmDialog(`Log "${item}" right now?`)) return;
          const iso=localISO(new Date());
          const resp=await apiPOST({action:'log', item, ts:iso});
          if(resp.ok){ toast(`Logged ${item}`); await refreshAll(); } else statusMsg('Failed to log',true);
        };
        panel.appendChild(btn);
      });
    }

    // ---- Refresh All ----
    async function refreshAll(){
      const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
      const start=new Date(y,m,1), end=new Date(y,m+1,0,23,59,59);
      try{
        const itemsResp=await apiGET('action=items'); if(itemsResp.ok) renderButtonsPanel(itemsResp.items||[]);
        const lastResp=await apiGET('action=last');  if(lastResp.ok)  lastTaken = lastResp.data||[]; renderLastPanel();
        const listResp=await apiGET(`action=list&start=${encodeURIComponent(start.toISOString())}&end=${encodeURIComponent(end.toISOString())}`);
        calendarData={};
        if(listResp.ok){ (listResp.data||[]).forEach(e=>{ const ds=fmtDate(new Date(e.iso)); (calendarData[ds] ||= []).push(e); }); }
        renderCalendar(); renderEntriesPanel();
      }catch(e){ statusMsg('Network or API error', true); }
    }

    // ---- Init ----
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('prevMonthBtn').onclick = prevMonth;
      document.getElementById('nextMonthBtn').onclick = nextMonth;
      refreshAll();
      if ('serviceWorker' in navigator) {
        // keep relative so it works under /peps/
        navigator.serviceWorker.register('./service-worker.js');
      }
    });
  </script>
</body>
</html>
