<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Peptide / Supplement Logger</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#3b82f6">
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f6f7fb; color:#222; }
    header { background:#3b82f6; color:#fff; padding: 1em; text-align:center; }
    .container { max-width:900px; margin:1em auto; padding:1em; background:#fff; box-shadow:0 2px 16px #0002; border-radius:1em; }
    #buttonsPanel { display:flex; flex-wrap:wrap; gap:0.5em; margin-bottom:1em; }
    #buttonsPanel button { padding:0.6em 1em; border:none; background:#e0e7ff; color:#1e293b; border-radius:0.6em; font-size:0.95em; cursor:pointer; transition:background 0.2s; }
    #buttonsPanel button:hover { background:#3b82f6; color:#fff; }
    #lastList { margin-bottom:1em; }
    .last-item { margin-bottom:0.3em; }
    #calendarEmbed { margin-top:2em; }
    #toast { position:fixed; left:50%; bottom:32px; transform:translateX(-50%); background:#3b82f6; color:#fff; padding:0.7em 1.5em; border-radius:2em; opacity:0; pointer-events:none; transition:opacity 0.4s;}
    #toast.visible { opacity:1; }
    #status { position:fixed; top:0; left:0; right:0; text-align:center; padding:0.7em 0; font-weight:bold; opacity:0; pointer-events:none; transition:opacity 0.4s;}
    #status.visible { opacity:1; }
    @media (max-width:650px) { .container { margin:0; border-radius:0; box-shadow:none; } }
  </style>
</head>
<body>
  <header>
    <h1>Peptide / Supplement Logger</h1>
  </header>
  <div class="container">
    <h2>Log Now</h2>
    <div id="buttonsPanel"></div>

    <h2>Last Taken</h2>
    <div id="lastList"></div>

    <h2>Your Google Calendar</h2>
    <div id="calendarEmbed">
      <iframe src="https://calendar.google.com/calendar/embed?src=bee22b0d7e26eb2a2fdfa9c41d59e9f822a61ed3a87c60a04a876e53bb4b6dfa%40group.calendar.google.com&ctz=America%2FChicago"
        style="border:0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
    </div>
  </div>
  <div id="toast"></div>
  <div id="status"></div>

  <script>
    // ===== CONFIG =====
    const APPS_SCRIPT_URL = 'PASTE_YOUR_GOOGLEUSERCONTENT_URL_HERE'; // full ...echo?...&lib=...
    const API_TOKEN = ''; // optional
    // ==================

    function toast(msg){
      const el=document.getElementById('toast'); el.textContent=msg;
      el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'), 2200);
    }
    function statusMsg(msg, isError=false){
      const el=document.getElementById('status'); el.textContent=msg;
      el.style.background=isError?'#e11d48':'#3b82f6';
      el.classList.add('visible'); setTimeout(()=>el.classList.remove('visible'), 3000);
    }

    // JSONP helper
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Math.random().toString(36).substr(2);
        window[cb]=(data)=>{ resolve(data); delete window[cb]; script.remove(); };
        const script=document.createElement('script');
        script.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
        script.onerror=reject;
        document.body.appendChild(script);
      });
    }

    async function loadItems(){
      try {
        const resp=await jsonp(APPS_SCRIPT_URL+'?action=items');
        if(resp.ok){
          const panel=document.getElementById('buttonsPanel');
          panel.innerHTML='';
          resp.items.forEach(name=>{
            const btn=document.createElement('button');
            btn.textContent=name;
            btn.onclick=()=>logItem(name);
            panel.appendChild(btn);
          });
        }
      } catch(err){ statusMsg('Error loading items',true); }
    }

    async function loadLast(){
      try {
        const resp=await jsonp(APPS_SCRIPT_URL+'?action=last');
        if(resp.ok){
          const list=document.getElementById('lastList');
          list.innerHTML='';
          (resp.data||[]).forEach(entry=>{
            const div=document.createElement('div');
            div.className='last-item';
            div.textContent=`${entry.item}: ${entry.iso}`;
            list.appendChild(div);
          });
        }
      } catch(err){ statusMsg('Error loading last taken',true); }
    }

    async function logItem(name){
      if(!confirm(`Log "${name}" now?`)) return;
      try {
        const ts=new Date().toISOString();
        const resp=await jsonp(APPS_SCRIPT_URL+`?action=log&item=${encodeURIComponent(name)}&ts=${encodeURIComponent(ts)}`);
        if(resp.ok){ toast(`Logged ${name}`); loadLast(); }
        else statusMsg('Failed to log',true);
      } catch(err){ statusMsg('Network error logging item',true); }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      loadItems();
      loadLast();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
    });
  </script>
</body>
</html>
